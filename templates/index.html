<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>POS con Facturación CFDI</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css" />
    <style>
        .product-image {
            height: 200px;
            object-fit: cover;
        }
        .low-stock {
            background-color: #fff3cd;
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <h1>Punto de Venta</h1>
        
        <!-- Navigation Tabs -->
        <ul class="nav nav-tabs mb-4" id="mainTabs" role="tablist">
            <li class="nav-item">
                <a class="nav-link active" id="pos-tab" data-bs-toggle="tab" href="#pos" role="tab">Nueva Venta</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="sales-tab" data-bs-toggle="tab" href="#sales" role="tab">Gestión de Ventas</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="global-invoice-tab" data-bs-toggle="tab" href="#global-invoice" role="tab">Factura Global</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="product-tab" data-bs-toggle="tab" href="#product" role="tab">Gestión de Productos</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="clients-tab" data-bs-toggle="tab" href="#clients" role="tab">Gestión de Clientes</a>
            </li>
        </ul>

        <!-- Tab Content -->
        <div class="tab-content">
            <!-- POS Tab -->
            <div class="tab-pane fade show active" id="pos" role="tabpanel">
                <div class="row">
                    <div class="col-md-6">
                        <h2>Selección de Productos</h2>
                        <div class="card mb-4">
                            <div class="card-body">
                                <div class="mb-3">
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="productSearch" placeholder="Buscar producto por nombre o SKU...">
                                        <button class="btn btn-outline-secondary" type="button" onclick="searchProducts()">
                                            <i class="bi bi-search"></i>
                                        </button>
                                    </div>
                                </div>
                                <div id="productResults" class="list-group">
                                    <!-- Results will be loaded here -->
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <h2>Carrito de Compra</h2>
                        <div class="card">
                            <div class="card-body">
                                <table id="cartTable" class="table">
                                    <thead>
                                        <tr>
                                            <th>Producto</th>
                                            <th>Cantidad</th>
                                            <th>Precio</th>
                                            <th>Subtotal</th>
                                            <th>Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Cart items will be loaded here -->
                                    </tbody>
                                    <tfoot>
                                        <tr>
                                            <td colspan="3" class="text-end"><strong>Total:</strong></td>
                                            <td colspan="2"><strong id="cartTotal">$0.00</strong></td>
                                        </tr>
                                    </tfoot>
                                </table>
                                
                                <div class="mt-3">
                                    <button class="btn btn-success" onclick="finalizarVenta()">
                                        <i class="bi bi-check-circle"></i> Finalizar Venta
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Product Management Tab -->
            <div class="tab-pane fade" id="product" role="tabpanel">
                <div class="container mt-4" id="productManagement">
                    <div class="row mb-4">
                        <div class="col">
                            <button class="btn btn-primary" onclick="showProductModal()">
                                <i class="fas fa-plus"></i> Nuevo Producto
                            </button>
                        </div>
                    </div>

                    <!-- Filtros y búsqueda -->
                    <div class="row mb-4">
                        <div class="col-md-4">
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-search"></i></span>
                                <input type="text" id="searchInput" class="form-control" placeholder="Buscar productos...">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <select id="stockFilter" class="form-select">
                                <option value="all">Todos los productos</option>
                                <option value="low">Bajo stock</option>
                                <option value="out">Sin stock</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <select id="sortBy" class="form-select">
                                <option value="name">Ordenar por nombre</option>
                                <option value="stock">Ordenar por stock</option>
                                <option value="price">Ordenar por precio</option>
                            </select>
                        </div>
                    </div>

                    <!-- Lista de productos -->
                    <div class="row" id="productList">
                        <!-- Los productos se cargarán aquí dinámicamente -->
                    </div>
                </div>
            </div>

            <!-- Other tabs remain the same -->
            
        </div>
    </div>

    <!-- Product Modal -->
    <div class="modal fade" id="productModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="productModalLabel">Nuevo Producto</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="productForm">
                        <input type="hidden" id="productId">
                        <div class="mb-3">
                            <label for="name" class="form-label">Nombre</label>
                            <input type="text" class="form-control" id="name" required>
                        </div>
                        <div class="mb-3">
                            <label for="sku" class="form-label">SKU</label>
                            <input type="text" class="form-control" id="sku" required>
                        </div>
                        <div class="mb-3">
                            <label for="price" class="form-label">Precio</label>
                            <input type="number" class="form-control" id="price" step="0.01" required>
                        </div>
                        <div class="mb-3">
                            <label for="stock" class="form-label">Stock</label>
                            <input type="number" class="form-control" id="stock" required>
                        </div>
                        <div class="mb-3">
                            <label for="minStock" class="form-label">Stock Mínimo</label>
                            <input type="number" class="form-control" id="minStock" required>
                        </div>
                        <div class="mb-3">
                            <label for="description" class="form-label">Descripción</label>
                            <textarea class="form-control" id="description" rows="3"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="imageUrl" class="form-label">URL de Imagen</label>
                            <input type="url" class="form-control" id="imageUrl">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="saveProduct()">Guardar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Variables globales
        let products = [];
        let cart = [];
        const productModal = new bootstrap.Modal(document.getElementById('productModal'));

        // Product Management Functions
        function displayProducts(filteredProducts = null) {
            const productsToShow = filteredProducts || products;
            const productList = document.getElementById('productList');
            productList.innerHTML = '';

            productsToShow.forEach(product => {
                const col = document.createElement('div');
                col.className = 'col-md-4 mb-4';
                const isLowStock = product.stock <= product.min_stock;
                
                col.innerHTML = `
                    <div class="card ${isLowStock ? 'low-stock' : ''}">
                        <img src="${product.image_url || '/static/img/no-image.png'}" class="card-img-top product-image" alt="${product.name}">
                        <div class="card-body">
                            <h5 class="card-title">${product.name}</h5>
                            <p class="card-text">
                                SKU: ${product.sku}<br>
                                Precio: $${product.price.toFixed(2)}<br>
                                Stock: ${product.stock} ${isLowStock ? '<span class="badge bg-warning">Bajo Stock</span>' : ''}
                            </p>
                            <div class="btn-group">
                                <button class="btn btn-primary" onclick="editProduct(${product.id})">
                                    <i class="fas fa-edit"></i> Editar
                                </button>
                                <button class="btn btn-danger" onclick="deleteProduct(${product.id})">
                                    <i class="fas fa-trash"></i> Eliminar
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                productList.appendChild(col);
            });
        }

        function filterProducts() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const stockFilter = document.getElementById('stockFilter').value;
            const sortBy = document.getElementById('sortBy').value;

            let filtered = products.filter(product => {
                const matchesSearch = product.name.toLowerCase().includes(searchTerm) ||
                                   product.sku.toLowerCase().includes(searchTerm);
                
                if (stockFilter === 'low') {
                    return matchesSearch && product.stock <= product.min_stock && product.stock > 0;
                } else if (stockFilter === 'out') {
                    return matchesSearch && product.stock === 0;
                }
                return matchesSearch;
            });

            filtered.sort((a, b) => {
                switch (sortBy) {
                    case 'name':
                        return a.name.localeCompare(b.name);
                    case 'stock':
                        return b.stock - a.stock;
                    case 'price':
                        return b.price - a.price;
                    default:
                        return 0;
                }
            });

            displayProducts(filtered);
        }

        function showProductModal(productId = null) {
            const form = document.getElementById('productForm');
            form.reset();
            document.getElementById('productId').value = '';
            document.getElementById('productModalLabel').textContent = 'Nuevo Producto';
            
            if (productId) {
                const product = products.find(p => p.id === productId);
                if (product) {
                    document.getElementById('productModalLabel').textContent = 'Editar Producto';
                    document.getElementById('productId').value = product.id;
                    document.getElementById('name').value = product.name;
                    document.getElementById('sku').value = product.sku;
                    document.getElementById('price').value = product.price;
                    document.getElementById('stock').value = product.stock;
                    document.getElementById('minStock').value = product.min_stock;
                    document.getElementById('description').value = product.description || '';
                    document.getElementById('imageUrl').value = product.image_url || '';
                }
            }
            
            productModal.show();
        }

        // Event listeners
        document.getElementById('product-tab').addEventListener('shown.bs.tab', function (e) {
            loadProducts();
        });

        if (document.getElementById('searchInput')) {
            document.getElementById('searchInput').addEventListener('input', filterProducts);
            document.getElementById('stockFilter').addEventListener('change', filterProducts);
            document.getElementById('sortBy').addEventListener('change', filterProducts);
        }

        // Initialize
        loadProducts();
    </script>
</body>
</html>
